@page "/login"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components.Web

@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Login | DAIS</PageTitle>

<form>
    <fieldset>
        <label>
            Username:
            <input type="text" @bind="_userName" autocomplete="username" />
        </label>
        <label>
            Password:
            <input type="password" @bind="_password" autocomplete="current-password" />
        </label>
    </fieldset>

    <small id="login-status">
        @if (_isInvalid)
        {
            @:Invalid username or password!
        }
        else
        {
            @:&nbsp;
        }
    </small>

    <button aria-busy="@_isBusy" @onclick="TryToLogin" @onclick:preventDefault="true">Login</button>
</form>

@code {

    // NEW: вместо старого AuthorizeCallback
    [Parameter, SupplyParameterFromQuery]
    public string? returnUrl { get; set; } = "/";

    private string _userName = "";
    private string _password = "";

    private bool _isInvalid;
    private bool _isBusy;

    private async Task TryToLogin(MouseEventArgs evt)
    {
        _isInvalid = false;
        _isBusy = true;

        var content = new FormUrlEncodedContent(new Dictionary<string, string>
        {
            ["username"] = _userName,
            ["password"] = _password,
            ["returnUrl"] = returnUrl ?? "/"
        });

        using HttpClient http = new() { BaseAddress = new Uri(Nav.BaseUri) };
        var response = await http.PostAsync("/auth/login-check", content);
        var result = await response.Content.ReadFromJsonAsync<LoginCheckResult>();

        _isBusy = false;

        if (result is null || !result.success)
        {
            _isInvalid = true;
            return;
        }

        await JS.InvokeVoidAsync("daisAuth.loginCommit", result.userName, result.displayName);

        Nav.NavigateTo(returnUrl ?? "/", forceLoad: true);
    }

    private class LoginCheckResult
    {
        public bool success { get; set; }
        public string? userName { get; set; }
        public string? displayName { get; set; }
    }
}